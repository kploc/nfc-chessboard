
/*
 * kts1622.c
 *
 *  Created on: Oct 23, 2022
 *      Author: vanish
 */
 
 #include "kts1622.h"
 
 static uint8_t antenna[64][7] = {
	 
		/* Dane potrzebne do zmiany miedzy polami */
	
		/* 0 B1*/
    {0x00, 0x03, 0x72, 0x00, 0x00, 0x00, 0x00},
		/* 1 C1*/
    {0x00, 0x03, 0x62, 0x00, 0x00, 0x00, 0x00},
		/* 2 D1*/
		{0x00, 0x03, 0x52, 0x00, 0x00, 0x00, 0x00},
		
		/* 3 E1*/
    {0x00, 0x03, 0x82, 0x00, 0x00, 0x00, 0x00},
		/* 4 F1*/
		{0x00, 0x03, 0x8E, 0x00, 0x00, 0x00, 0x00},
		/* 5 G1*/
    {0x00, 0x03, 0x8A, 0x00, 0x00, 0x00, 0x00},
		/* 6 H1*/
		{0x00, 0x03, 0x86, 0x00, 0x00, 0x00, 0x00},
		
		/* 7 A2*/
    {0x00, 0x03, 0x90, 0x00, 0x00, 0x00, 0x00},
		/* 8 B2*/
    {0x00, 0x03, 0x91, 0x00, 0x02, 0xC9, 0x01},
		/* 9 C2*/
    {0x00, 0x02, 0x49, 0x00, 0x00, 0x00, 0x00},
		/* 10 D2*/
		{0x00, 0x03, 0x90, 0x00, 0x02, 0xC9, 0x01},
		
		/* 11 E2*/
    {0x00, 0x03, 0x92, 0x00, 0x02, 0x09, 0x01},
		/* 12 F2*/
		{0x00, 0x02, 0x39, 0x00, 0x00, 0x00, 0x00},
		/* 13 G2*/
    {0x00, 0x02, 0x29, 0x00, 0x00, 0x00, 0x00},
		/* 14 H2*/
		{0x00, 0x02, 0x19, 0x00, 0x00, 0x00, 0x00},
		
		/* 15 A3*/
    {0x00, 0x02, 0x41, 0x00, 0x00, 0x00, 0x00},
		/* 16 B3*/
    {0x00, 0x02, 0x47, 0x00, 0x00, 0x00, 0x00},
		/* 17 C3*/
    {0x00, 0x02, 0x45, 0x00, 0x00, 0x00, 0x00},
		/* 18 D3*/
		{0x00, 0x02, 0x43, 0x00, 0x00, 0x00, 0x00},
		
		/* 19 E3*/
    {0x00, 0x02, 0x48, 0x00, 0x00, 0x00, 0x00},
		/* 20 F3*/
		{0x01, 0x03, 0xE4, 0x00, 0x00, 0x00, 0x00},
		/* 21 G3*/
    {0x01, 0x03, 0xA4, 0x00, 0x00, 0x00, 0x00},
		/* 22 H3*/
		{0x01, 0x03, 0x64, 0x00, 0x00, 0x00, 0x00},
		
		/* 23 A4*/
    {0x00, 0x02, 0x49, 0x01, 0x03, 0x04, 0x01},
		/* 24 B4*/
    {0x01, 0x03, 0x1C, 0x00, 0x00, 0x00, 0x00},
		/* 25 C4*/
    {0x01, 0x03, 0x14, 0x00, 0x00, 0x00, 0x00},
		/* 26 D4*/
		{0x01, 0x03, 0x0C, 0x00, 0x00, 0x00, 0x00},
		
		/* 27 E4*/
    {0x01, 0x03, 0x20, 0x00, 0x00, 0x00, 0x00},
		/* 28 F4*/
		{0x01, 0x03, 0x23, 0x00, 0x00, 0x00, 0x00},
		/* 29 G4*/
    {0x01, 0x03, 0x22, 0x00, 0x00, 0x00, 0x00},
		/* 30 H4*/		
		{0x01, 0x03, 0x21, 0x00, 0x00, 0x00, 0x00},
		
		/* 31 A5*/
    {0x01, 0x03, 0x24, 0x01, 0x02, 0x12, 0x01},	
		/* 32 B5*/
    {0x01, 0x02, 0x72, 0x00, 0x00, 0x00, 0x00},
		/* 33 C5*/
    {0x01, 0x02, 0x62, 0x00, 0x00, 0x00, 0x00},
		/* 34 D5*/
		{0x01, 0x02, 0x52, 0x00, 0x00, 0x00, 0x00},
		
		/* 35 E5*/
    {0x01, 0x02, 0x82, 0x00, 0x00, 0x00, 0x00},
		/* 36 F5*/
		{0x01, 0x02, 0x8E, 0x00, 0x00, 0x00, 0x00},
		/* 37 G5*/
    {0x01, 0x02, 0x8A, 0x00, 0x00, 0x00, 0x00},
		/* 38 H1*/
		{0x01, 0x02, 0x86, 0x00, 0x00, 0x00, 0x00},
		
		/* 39 A6*/
    {0x01, 0x02, 0x90, 0x00, 0x00, 0x00, 0x00},
		/* 40 B6*/
    {0x01, 0x02, 0x91, 0x02, 0x03, 0xC9, 0x01},
		/* 41 C6*/
    {0x02, 0x03, 0x49, 0x00, 0x00, 0x00, 0x00},
		/* 42 D6*/
		{0x01, 0x02, 0x90, 0x02, 0x03, 0xC9, 0x01},
		
		/* 43 E6*/
    {0x01, 0x02, 0x92, 0x02, 0x03, 0x09, 0x01},
		/* 44 F6*/
		{0x02, 0x03, 0x39, 0x00, 0x00, 0x00, 0x00},
		/* 45 G6*/
    {0x02, 0x03, 0x29, 0x00, 0x00, 0x00, 0x00},
		/* 46 H6*/
		{0x02, 0x03, 0x19, 0x00, 0x00, 0x00, 0x00},
		
		/* 47 A7*/
    {0x02, 0x03, 0x41, 0x00, 0x00, 0x00, 0x00},
		/* 48 B7*/
    {0x02, 0x03, 0x47, 0x00, 0x00, 0x00, 0x00},
		/* 49 C7*/
    {0x02, 0x03, 0x45, 0x00, 0x00, 0x00, 0x00},
		/* 50 D7*/
		{0x02, 0x03, 0x43, 0x00, 0x00, 0x00, 0x00},
		
		/* 51 E7*/
    {0x02, 0x03, 0x48, 0x00, 0x00, 0x00, 0x00},
		/* 52 F7*/
		{0x02, 0x02, 0xE4, 0x00, 0x00, 0x00, 0x00},
		/* 53 G7*/
    {0x02, 0x02, 0xA4, 0x00, 0x00, 0x00, 0x00},
		/* 54 H7*/
		{0x02, 0x02, 0x64, 0x00, 0x00, 0x00, 0x00},
		
		/* 55 A8*/
    {0x02, 0x03, 0x49, 0x02, 0x02, 0x04, 0x01},
		/* 56 B8*/
    {0x02, 0x02, 0x1C, 0x00, 0x00, 0x00, 0x00},
		/* 57 C8*/
    {0x02, 0x02, 0x14, 0x00, 0x00, 0x00, 0x00},
		/* 58 D8*/
		{0x02, 0x02, 0x0C, 0x00, 0x00, 0x00, 0x00},
		
		/* 59 E8*/
    {0x02, 0x02, 0x20, 0x00, 0x00, 0x00, 0x00},
		/* 60 F8*/
		{0x02, 0x02, 0x23, 0x00, 0x00, 0x00, 0x00},
		/* 61 G8*/
    {0x02, 0x02, 0x22, 0x00, 0x00, 0x00, 0x00},
		/* 62 H8*/		
		{0x02, 0x02, 0x21, 0x00, 0x00, 0x00, 0x00},
		
		/* 63 A1*/
    {0x02, 0x02, 0x24, 0x00, 0x03, 0x12, 0x01},
};
 
void KTS_Init(void)
{
	uint8_t addr;	/* Zmienna zawierajaca adres rejestru KTS */
	uint8_t data[6] = {0x12, 0x49, 0x24, 0x92, 0x49, 0x24};	/* Zmienna zawierajaca dane wpisywane do rejestru */
	int i;	/* Zmienna do inkrementacji adresów KTS */
	
	I2C1->CR2 &= ~(unsigned int)(1<<10);	/* RD_WRN = 0 \\ Ustawienie wysylu dnych przez Master-a */
	I2C1->CR2 &= ~(unsigned int)(1<<11);	/* ADD10 = 0 \\ Ustawienie dlugosci adresu slave-a na 7bit */
	I2C1->CR2 &= ~(unsigned int)(0xFF<<0);	/* SADD = 0 \\ Zerowanie adresu slave-a */
	I2C1->CR2 |= 1<<6; /* SADD = 100 0000B \\ Ustawienie adresu slave-a na 0x50 */
	I2C1->CR2 |= 1<<25;	/* AUTOEND = 1 \\ Wlaczenie automatycznego zakonczenia transmisji */
	I2C1->CR2 |= 1<<17;	/* NBYTES = 10B \\ Ustawienie dlugosci transmisji na 2bajt */
	for(i=0; i<3; i++)
	{
		I2C1->CR2 &= ~(unsigned int)(0x0F<<0);	/* Czyszczenie poprzedniego adresu */
		I2C1->CR2 |= 1<<i;	/* Wybór urzadzenia */
		I2C1->CR2 |= 1<<13;	/* Start = 1 \\ Rozpoczenie wysylu danych */
		addr = 0x07;	/* Adres 7 KTS - odpowiedzialny za zmiane portów 1.. z input na output */
		while(!(I2C1->ISR & (1<<1)));	/* Sprawdzenie czy rejestr danych jest pusty */
		I2C1->TXDR = addr;	
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = 0x00;	
		addr = 0x06;	/* Adres 6 KTS - odpowiedzialny za zmiane portów 0.. z input na output */
		I2C1->CR2 |= 1<<13;	
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = addr;
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = 0x00;
		addr = 0x03;	/* Adres 3 KTS - odpowiedzialny za zmiane portów 1.. z low na high */
		I2C1->CR2 |= 1<<13;	
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = addr;
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = data[i*2];
		addr = 0x02;	/* Adres 3 KTS - odpowiedzialny za zmiane portów 0.. z low na high */
		I2C1->CR2 |= 1<<13;	
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = addr;
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = data[i*2+1];
	}
}

void switchAnt(uint8_t field)
{
	uint8_t addr = antenna[field][1];
	uint8_t data = antenna[field][2];
	
	I2C1->CR2 &= ~(unsigned int)(0x0F<<0);
	I2C1->CR2 |= 1<<antenna[field][0];
	I2C1->CR2 |= 1<<13;	
	while(!(I2C1->ISR & (1<<1)));
	I2C1->TXDR = addr;
	while(!(I2C1->ISR & (1<<1)));
	I2C1->TXDR = data;
	if(antenna[field][6])
	{
		addr = antenna[field][4];
		data = antenna[field][5];
		I2C1->CR2 &= ~(unsigned int)(0x0F<<0);
		I2C1->CR2 |= 1<<antenna[field][3];
		I2C1->CR2 |= 1<<13;	
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = addr;
		while(!(I2C1->ISR & (1<<1)));
		I2C1->TXDR = data;
	}
}
